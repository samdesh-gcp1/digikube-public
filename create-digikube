#!/bin/bash
#All starts here

digikubeCodeRawRepoUrl="https://raw.githubusercontent.com/samdesh-gcp1/digikube-core/master"
digikubeInstanceRawRepoUrl="https://raw.githubusercontent.com/samdesh-gcp1/c1-dev1/master"
digikubeMasterProject="digikube-master3"
digikubeCoreRepoAccessToken="digikube-github-access-token-secret"
digikubeCoreRepoAccessTokenVersion="latest"

digikubeCoreRepoAccessToken=$(gcloud beta secrets versions access ${digikubeCoreRepoAccessTokenVersion} --secret=${digikubeCoreRepoAccessToken} --project=${digikubeMasterProject})
echo $digikubeCoreRepoAccessToken

tmpExecDir=$(mktemp -d --suffix="-digikube")
bootstrapShell="${tmpExecDir}/bootstrap"
wget --no-cache \
	 --header="Authorization: token ${digikubeCoreRepoAccessToken}" \
	 -O ${bootstrapShell} - "${digikubeCodeRawRepoUrl}/cloud-init/bootstrap"
chmod +x ${bootstrapShell}
${bootstrapShell} ${digikubeCodeRawRepoUrl} ${digikubeInstanceRawRepoUrl} create
rm -rf "${tmpExecDir}"
digikubeCoreRepoAccessToken=""
unset digikubeCoreRepoAccessToken
